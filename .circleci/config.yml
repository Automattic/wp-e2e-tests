version: 2
jobs:
  build:
    working_directory: /home/circleci/wp-e2e-tests
    docker:
      - image: circleci/node:6.10.2
        environment:
                NODE_ENV: test
    steps:
      - checkout
      - run: npm install
      - setup_remote_docker
      - run:
          name: Create shared data volume and network
          command: |
            set -x
            docker volume create wp-e2e-tests-data-volume
            docker create -v wp-e2e-tests-data-volume:/wp-e2e-tests --name wp-e2e-tests-data-container alpine:3.4 /bin/true
            docker cp /home/circleci/wp-e2e-tests wp-e2e-tests-data-container:/
            docker network create e2e
      - run: 
          name: Start Selenium Server
          command: |
            set -x
            docker run -d --network=e2e --rm -e JAVA_OPTS=-Xmx1024m -v /dev/shm:/dev/shm -v wp-e2e-tests-data-volume:/home/circleci/wp-e2e-tests --name selenium selenium/standalone-chrome:3.3.0 
      - run:
          name: Run Tests
          command: |
            set -x
            docker run \
              -it \
              --network=e2e \
              -e SELENIUM_REMOTE_URL=http://selenium:4444/wd/hub \
              -e BROWSERSIZE \
              -e CIRCLE_BRANCH \
              -e CIRCLE_BUILD_NUM \
              -e CIRCLE_TEST_REPORTS \
              -e CIRCLE_PROJECT_USERNAME \
              -e CIRCLE_PROJECT_REPONAME \
              -e NODE_CONFIG \
              -e NODE_ENV \
              -w /home/circleci/wp-e2e-tests \
              -v wp-e2e-tests-data-volume:/home/circleci/wp-e2e-tests \
              -v /dev/shm:/dev/shm \
              -u root \
              circleci/node:6.10.2 ./node_modules/.bin/magellan --max_test_attempts=1 --max_workers=3
